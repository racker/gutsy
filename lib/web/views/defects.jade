extends layout
block append scripts
  link(href="/static/css/burndown.css", type="text/css", rel="stylesheet")
  script(src='/static/js/defects.js')
  script
    $(function() {
      $("table#defects").tablesorter();
    });
  script(src='https://www.google.com/jsapi', type="text/javascript")
  script(src='/static/js/burndown.js', type="text/javascript")
  |<script type="text/javascript">
  |    var burndown_data = !{JSON.stringify(burndown.data)};
  |</script

block content
  .container
    .content
      if burndown.error

        p The version_one API returned the following error (for burndown ):
        p.alert!=trace(burndown.error)
      else if burndown.data
        h1 VersionOne - The Burndown
        div#tasks-chart.burndown-chart
        div#defects-chart.burndown-chart
        div(style="clear:both")

      if version_one
        h1.title VersionOne - Defects   
          span.sevcount #{version_one.data.total}
        if version_one.error
          p The version_one API returned the following error:
          p.alert!=trace(version_one.error)
        else
          div
            - each v, k in version_one.data.byAge
              hr
              h2.title
                span.arrow \u25B6
                span.sevcount #{v.total_count}
                #{k}
                for vcount, ksev in v.sev_count
                  if vcount != 0
                      if ksev === "1"
                        span.sev.sev1(title="Severity 1") #{vcount}
                      if ksev === "2"
                        span.sev.sev2(title="Severity 2") #{vcount}
                      if ksev === "3"
                        span.sev.sev3(title="Severity 3") #{vcount}
                      if ksev === "4"
                        span.sev.sev4(title="Severity 4") #{vcount}
                      if ksev === "?"
                        span.sev.sevq(title="Severity Unknown") #{vcount}
              div.table.collapsible
                table#defects.sortable.table-striped.hide
                  thead
                    tr
                      th Created
                      th Status
                      th Severity
                      th Changed By
                      th Defect Name
                  tbody
                    if v.defects.length
                      - each asset in v.defects
                        tr
                          td #{new Date(asset.attributes['CreateDate']).getMonth()+1}/#{new Date(asset.attributes['CreateDate']).getDate()}
                          td #{asset.attributes['Status.Name'] || '-'}
                          td(class="sev#{asset.severity}") #{asset.attributes['Custom_Severity.Name'] || '-'}
                          td
                            a(href="http://#{version_one.config.host}/#{version_one.config.name}/member.mvc/Summary?oidToken=#{asset.relations['ChangedBy'].idref}") #{asset.attributes['ChangedBy.Name'] || '-'}
                          td
                            a(href=utils.v1_id_to_url(version_one.config, asset.id)) #{asset.attributes['Name']}
                    else
                      p No defects!
